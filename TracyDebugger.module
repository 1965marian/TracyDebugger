<?php

/**
 * Processwire module for running the Tracy debugger from Nette.
 * by Adrian Jones
 *
 * ProcessWire 2.x
 * Copyright (C) 2011 by Ryan Cramer
 * Licensed under GNU/GPL v2, see LICENSE.TXT
 *
 * http://www.processwire.com
 * http://www.ryancramer.com
 *
 */

// TODO would like to move this so it's not loaded unless superuser and module is enabled
require $this->wire('config')->paths->siteModules.'TracyDebugger/tracy/src/tracy.php';

use Tracy\Debugger;
use Tracy\IBarPanel;


class TracyDebugger extends WireData implements Module, ConfigurableModule {

    /**
     * Basic information about module
     */
    public static function getModuleInfo() {
        return array(
            'title' => 'Tracy Debugger',
            'summary' => 'Tracy debugger from Nette.',
            'href' => '',
            'version' => 3,
            'autoload' => true,
            'singular' => true,
            'icon' => 'bug'
        );
    }


    /**
     * Data as used by the get/set functions
     *
     */
    protected $data = array();


   /**
     * Default configuration for module
     *
     */
    static public function getDefaultData() {
            return array(
                "enabled" => 1,
                "showDebugBar" => 1,
                "strictMode" => null,
                "outputMode" => 'detect',
                "email" => ''
            );
    }


    /**
     * Populate the default config data
     *
     */
    public function __construct() {
       foreach(self::getDefaultData() as $key => $value) {
               $this->$key = $value;
       }
    }

    /**
     * Initialize the module and setup hooks
     */
    public function init() {

        if(!wire('user')->isSuperuser() || !$this->data['enabled']) return;

        if($this->data['outputMode'] == 'production') {
            $outputMode = Debugger::PRODUCTION;
        }
        elseif($this->data['outputMode'] == 'development') {
            $outputMode = Debugger::DEVELOPMENT;
        }
        else {
            $outputMode = Debugger::DETECT;
        }

        $logFolder = $this->wire('config')->paths->logs.'tracy';
        if(!is_dir($logFolder)) wireMkdir($logFolder);

        Debugger::enable($outputMode, $logFolder, $this->data['email']);

        $this->data['showDebugBar'] ? Debugger::$showBar = TRUE : Debugger::$showBar = FALSE;
        $this->data['strictMode'] ? Debugger::$strictMode = TRUE : Debugger::$strictMode = FALSE;

        Debugger::getBar()->addPanel(new ProcessWirePanel);

        //if($this->data['email']) Debugger::$email = $this->data['email'];

        //Debugger::$scream = TRUE;

        //if($this->data['logSeverity']) Debugger::$logSeverity = E_NOTICE | E_WARNING;

    }


    /**
     * Return an InputfieldWrapper of Inputfields used to configure the class
     *
     * @param array $data Array of config values indexed by field name
     * @return InputfieldsWrapper
     *
     */
    public static function getModuleConfigInputfields(array $data) {

        $data = array_merge(self::getDefaultData(), $data);

        $wrapper = new InputfieldWrapper();

        $f = wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'enabled');
        $f->label = __('Enable Tracy Debugger', __FILE__);
        $f->description = __('Uncheck to disable the Tracy Debugger.', __FILE__);
        $f->attr('checked', $data['enabled'] == '1' ? 'checked' : '' );
        $wrapper->add($f);

        $f = wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'showDebugBar');
        $f->label = __('Show Debug Bar', __FILE__);
        $f->description = __('Uncheck to hide the debug bar.', __FILE__);
        $f->showIf = "enabled=1";
        $f->columnWidth = 33;
        $f->attr('checked', $data['showDebugBar'] == '1' ? 'checked' : '' );
        $wrapper->add($f);

        $f = wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'strictMode');
        $f->label = __('Strict Mode', __FILE__);
        $f->description = __('Check to enable strict mode.', __FILE__);
        $f->showIf = "enabled=1";
        $f->columnWidth = 34;
        $f->attr('checked', $data['strictMode'] == '1' ? 'checked' : '' );
        $wrapper->add($f);

        $f = wire('modules')->get("InputfieldSelect");
        $f->attr('name', 'outputMode');
        $f->label = 'Output Mode';
        $f->description = __('The DETECT option automatically switches from DEVELOPMENT to PRODUCTION mode based on whether the IP of the site is publicly accessible or not.', __FILE__);
        $f->showIf = "enabled=1";
        $f->columnWidth = 33;
        $f->required = true;
        $f->addOption('detect', 'DETECT');
        $f->addOption('development', 'DEVELOPMENT');
        $f->addOption('production', 'PRODUCTION');
        if($data['outputMode']) $f->attr('value', $data['outputMode']);
        $wrapper->add($f);

        $f = wire('modules')->get("InputfieldEmail");
        $f->attr('name', 'email');
        $f->label = __('Email for error logs', __FILE__);
        $f->description = __('This email address will receive notification of errors.', __FILE__);
        $f->showIf = "enabled=1";
        if($data['email']) $f->attr('value', $data['email']);
        $wrapper->add($f);

        return $wrapper;
    }

}

/**
 * Various helper methods
 */

function barDump($var, $title = NULL, array $options = NULL) {
    return Debugger::barDump($var, $title, $options);
}

/**
 * Custom PW panel
 */
// try a content of all fields on page accordion item

class ProcessWirePanel implements IBarPanel {
    public function getTab() {
        return '
        <style>
            .tracy-panel {
                max-height: 90% !important;
                max-width: 95% !important;
                overflow-y: scroll !important;
            }
        </style>
        <span title="ProcessWire debug info">
            <img style="height: 15px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAz5JREFUeNrEmL1y00AQgHWOB+hQQ8lE1BQoBTVKRWn7CWwNNQNuaO10dMFPIPsJojwAE6WkiuAFrAwFRQrUx1js2asZcd493UmO2Zkd2Rr79N3+64TTUu6ehwFcPFRVMtD02c8obbq+aADkwqUP2sOrieSgCeglwM4fBBDBPoJ+AHVbGF3CzkC/AGy+F0CAk2CTlmCU+8cAGTcGRKtdgAbOw8kcQXMrQIDzEc4zfFBC3DPdmEyiUwpSaOCualya4+4XuizFtYago5r1SEjBuPVGYzmrILdMsh1ICvBK4xrpxhAWyFrUTQ9Dx+diEtYPSUDM1nOTP+6hwEfodkoGZXYLZWc3jPn3CmcAKV38Qrq6W7nJ1bm4Dg43FyhxK8Mg0YWDXLfy36qU8ToVlQD+rduJJkPPa8pJjHUu02yO8tzm2R38wsXCWAM3woXrap3s10v8PWXFDKuCQ1ixXwL2qFbENXZ8WGQZchEHKUsWWkyVXkdT8Wea8SpqmBcRhoVqxbLo71i/Q/2hEjuUTGq6QYJXTrgytqBudpjMzamgxs0ETDLJDnACurnC9xPGbQEmhmrFlAPkLMEFPCUSKiEeOLBcJzEF5GrXK6ZOpkyGcu4+Ng1aDvCWuU+Fw3eDCVoV39QwHefhxWYK9yhAaodP99RrfcZa18YuZuLHbwv36/idq6mXXBLuPLdbyZ6goVv+kR8v33uP71f91f1qcrReu4LuUDFjbZcDvFQArS349fWniyerDZjzSAhnDepILYqd/s4sMdRlMbcjY/kjhL+G8bJAuEKy7f4s1LxmUrUx6VQmikQpDbkNIAC5G7jtZ4QU1fUGNcMH9Q60qA6sIY5dOU7QuZ2TRQhgw2JrSa9wRLYWTnq0DZ9YM7a5TH+Xv4+7ylw2bZocb799jjUDhlMzPHhMh8oPUah1dXKkeSc5O1QncRoMvbNymur+BzAX3cpN1/I8carWwUPBldO47tRiQBXqNvLGwGJ9PPLwa6aeU3VQtgW8JiZqOSEvsY7eKjOfb9iVSrjU6nyQeYdd7tnzKRbxzOp8sOGZiq2cVRPCZqLWybjmrc1E5nhiUdsYRItSMcHzE1PJsNPMbI7v/gowABRNYFmCWV57AAAAAElFTkSuQmCC" />
            ProcessWire
        </span>
        ';
    }

    protected function sectionHeader($columnNames = array()) {
        $out = '
        <div>
            <table>
                <thead>
                    <tr>';
        foreach($columnNames as $columnName) {
            $out .= '<th>'.$columnName.'</th>';
        }

        $out .= '
                    </tr>
                </thead>
            <tbody>
        ';
        return $out;
    }

    public function getPanel() {

        // end for each section
        $sectionEnd = '
                    </tbody>
                </table>
            </div>';

        // panel title
        $out = '
        <h1>ProcessWire Debug Info</h1>';


        // Pages Loaded
        $pagesInfo = $this->sectionHeader(array('ID', 'Path', 'Type', 'Loader'));
        foreach(wire('pages')->getCache() as $p) {
            $parts = explode('/', trim($p->path, '/'));
            $name = array_pop($parts);
            $path = implode('/', $parts) . "/<b>$name</b>/";
            if($path[0] != '/') $path = "/$path";
            $pagesInfo .= "\n<tr>" .
                "<td>$p->id</td>" .
                "<td>$path</td>" .
                "<td>" . wireClassName($p) . "</td>" .
                "<td>$p->_debug_loader</td>" .
                "</tr>";
        }
        $pagesInfo .= $sectionEnd;


        // API Variables
        $apiVariables = $this->sectionHeader(array('Name', 'Class'));
        foreach(wire('fuel') as $key => $value) {
            if(!is_object($value)) continue;
            $apiVariables .= "\n<tr><td><a target='_blank' href='https://processwire.com/api/variables/$key/'>\$$key</a></td>" .
                "<td>" . get_class($value) . "</td></tr>";
        }
        $apiVariables .= $sectionEnd;

        // Session
        $sessionEntries = $this->sectionHeader(array('Key', 'Value'));
        foreach(wire('session') as $key => $value) {
            if(is_object($value)) $value = (string) $value;
            if(is_array($value)) $value = print_r($value, true);
            $sessionEntries .= "<tr><td>$key</td><td><pre>" . wire('sanitizer')->entities($value) . "</pre></td></tr>";
        }
        $sessionEntries .= $sectionEnd;

        // Modules Loaded
        $modulesLoaded = $this->sectionHeader(array('Class', 'Version', 'Title'));
        foreach(wire('modules') as $module) {
            if($module instanceof ModulePlaceholder) continue;
            $info = wire('modules')->getModuleInfo($module, array('verbose' => false));
            $modulesLoaded .= "<tr>";
            $modulesLoaded .= "<td>$info[name]</td>";
            $modulesLoaded .= "<td>$info[version]</td>";
            $modulesLoaded .= "<td>$info[title]</td>";
            $modulesLoaded .= "</tr>";
        }
        $modulesLoaded .= $sectionEnd;

        // Hooks
        $hooksCalled = $this->sectionHeader(array('When', 'Method::object', 'Visited by', 'Type', 'Priority'));
        $hooks = array_merge(wire('pages')->getHooks('*'), wire('hooks')->getAllLocalHooks());
        $hooksSorted = array();
        foreach($hooks as $hook) {
            $whenKey = $hook['options']['before'] ? '0' : '1';
            $sortKey = $hook['options']['fromClass'] . ":$hook[method]:$whenKey:" . $hook['options']['priority'];
            $hooksSorted[$sortKey] = $hook;
        }
        ksort($hooksSorted);
        foreach($hooksSorted as $key => $hook) {
            $suffix = $hook['options']['type'] == 'method' ? '()' : '';
            $toObject = !empty($hook['toObject']) ? $hook['toObject'] : '';
            $toMethod = $hook['toMethod'];
            if(is_callable($toMethod)) $toMethod = 'anonymous function';
            $hooksCalled .= "<tr>";
            $hooksCalled .= "<td>" . ($hook['options']['before'] ? 'before ' : '') . ($hook['options']['after'] ? 'after' : '') . "</td>";
            $hooksCalled .= "<td>" . ($hook['options']['fromClass'] ? $hook['options']['fromClass'] . '::' : '') . "$hook[method]$suffix</td>";
            $hooksCalled .= "<td>" . ($toObject ? "$toObject::$toMethod" : $toMethod) . "()</td>";
            $hooksCalled .= "<td>" . ($hook['options']['allInstances'] || $hook['options']['fromClass'] ? "class " : "instance ") . $hook['options']['type'] . "</td>";
            $hooksCalled .= "<td>" . $hook['options']['priority'] . "</td>";
            $hooksCalled .= "</tr>";
        }
        $hooksCalled .= $sectionEnd;

        // Database Queries
        $databaseQueries = $this->sectionHeader(array('Order', 'Query'));
        foreach(wire('database')->queryLog() as $n => $sql) $databaseQueries .= "\n<tr><th>$n</th><td>$sql</td></tr>";
        $databaseQueries .= $sectionEnd;

        // Timers
        $timers = $this->sectionHeader(array('Timer', 'Seconds'));
        $savedTimers = Debug::getSavedTimers();
        foreach($savedTimers as $name => $timer) $timers .= "\n<tr><th>$name</th><td>$timer</td></tr>";
        $timers .= $sectionEnd;

        // User
        $userDetails = '
        <h2><strong>Current User Roles</strong></h2>
        <ol>';
        foreach(wire('user')->roles as $role) $userDetails .= "\n<li>{$role->name}</li>";
        $userDetails .= '
        </ol>
        <h2><strong>Current User Permissions</strong></h2>
        <ol>';
        foreach(wire('user')->getPermissions() as $permission) $userDetails .= "\n<li>{$permission->name}</li>";
        $userDetails .= '</ol>
        <h2><strong>Current User Permissions on this page</strong></h2>
        <ol>';
        foreach(wire('user')->getPermissions(wire('page')) as $permission) $userDetails .= "\n<li>{$permission->name}</li>";
        $userDetails .= '</ol>';

        // GET, POST, & COOKIE
        foreach(array('get', 'post', 'cookie') as $type) {
            $i = wire('input')->$type;
            if(!count($i)) continue;
            $input[$type] = $this->sectionHeader(array('Key', 'Value'));
            foreach($i as $key => $value) {
                if(is_array($value)) $value = print_r($value, true);
                $input[$type] .= "<tr><td>" . wire('sanitizer')->entities($key) . "</td><td><pre>" . wire('sanitizer')->entities($value) . "</pre></td></tr>";
            }
            $input[$type] .= $sectionEnd;
        }


        // Cache
        $cacheDetails = '';
        foreach(wire('cache')->getInfo() as $info) {
            $cacheDetails .= "<table class=''><thead><tr><th colspan='2'>";
            $cacheDetails .= wire('sanitizer')->entities($info['name']) . "</th></tr></thead><tbody>";
            foreach($info as $key => $value) {
                if($key == 'name') continue;
                if($key == 'size') $value = wireBytesStr($value);
                $key = wire('sanitizer')->entities($key);
                $value = wire('sanitizer')->entities($value);
                $cacheDetails .= "<tr><th width='30%'>$key</th><td>$value</td></tr>";
            }
            $cacheDetails .= "</tbody></table><br />";
        }

        // Autoload
        $autoload = $this->sectionHeader(array('Class', 'File/Details'));
        foreach(wire('classLoader')->getDebugLog() as $className => $classFile) {
            $className = wire('sanitizer')->entities($className);
            $classFile = wire('sanitizer')->entities($classFile);
            $autoload .= "<tr><th width='40%'>$className</th><td>$classFile</td></tr>";
        }
        $autoload .= $sectionEnd;

        // Load all the panel sections
        $out = '
            <a href="#" rel="#pages-loaded" class="tracy-toggle tracy-collapsed">Pages Loaded</a>
            <div id="pages-loaded" class="tracy-collapsed">'.$pagesInfo.'</div><br />

            <a href="#" rel="#api-variables" class="tracy-toggle tracy-collapsed">API Variables</a>
            <div id="api-variables" class="tracy-collapsed">'.$apiVariables.'</div><br />

            <a href="#" rel="#session-entries" class="tracy-toggle tracy-collapsed">Session</a>
            <div id="session-entries" class="tracy-collapsed">'.$sessionEntries.'</div><br />

            <a href="#" rel="#modules-loaded" class="tracy-toggle tracy-collapsed">Modules Loaded</a>
            <div id="modules-loaded" class="tracy-collapsed">'.$modulesLoaded.'</div><br />

            <a href="#" rel="#hooks" class="tracy-toggle tracy-collapsed">Hooks</a>
            <div id="hooks" class="tracy-collapsed">'.$hooksCalled.'</div><br />

            <a href="#" rel="#database-queries" class="tracy-toggle tracy-collapsed">Database Queries</a>
            <div id="database-queries" class="tracy-collapsed">'.$databaseQueries.'</div><br />

            <a href="#" rel="#timers" class="tracy-toggle tracy-collapsed">Timers</a>
            <div id="timers" class="tracy-collapsed">'.$timers.'</div><br />

            <a href="#" rel="#user-details" class="tracy-toggle tracy-collapsed">User</a>
            <div id="user-details" class="tracy-collapsed">'.$userDetails.'</div><br />';

        if(isset($input['get'])) {
            $out .= '
            <a href="#" rel="#input-get" class="tracy-toggle tracy-collapsed">$input->get</a>
            <div id="input-get" class="tracy-collapsed">'.$input['get'].'</div><br />';
        }

        if(isset($input['post'])) {
            $out .= '
            <a href="#" rel="#input-post" class="tracy-toggle tracy-collapsed">$input->post</a>
            <div id="input-post" class="tracy-collapsed">'.$input['post'].'</div><br />';
        }

        if(isset($input['cookie'])) {
            $out .= '
            <a href="#" rel="#input-cookie" class="tracy-toggle tracy-collapsed">$input->cookie</a>
            <div id="input-cookie" class="tracy-collapsed">'.$input['cookie'].'</div><br />';
        }

        $out .= '
            <a href="#" rel="#cache-details" class="tracy-toggle tracy-collapsed">Cache</a>
            <div id="cache-details" class="tracy-collapsed">'.$cacheDetails.'</div><br />

            <a href="#" rel="#autoload" class="tracy-toggle tracy-collapsed">Autoload</a>
            <div id="autoload" class="tracy-collapsed">'.$autoload.'</div><br />
        ';

        return $out;
    }

}